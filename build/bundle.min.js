const $=(t,e)=>document["querySelector"+(e?"All":"")](t),fetchToJSON=async t=>{return await fetch(t).then(t=>t.json())},ord=t=>t+{e:"st",o:"nd",w:"rd",h:"th"}[new Intl.PluralRules("en",{type:"ordinal"}).select(t)[2]],createElement=(t,e,i)=>{let s=document.createElement(t);return e&&e.split(";").forEach(t=>{t&&(t=t.split(":"),s.setAttribute(t[0].trim(),t[1].trim()))}),s.innerHTML=i||"",s},wait=e=>new Promise(t=>setTimeout(t,e)),purify=t=>t.trim().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace("Ã¦","ae");class Switcher{constructor(){return this.panes=$(".pane",1),this.triggers=$(".pane-trigger",1),this.history=[],this}listen(){this.indexPanes();for(const t of this.triggers)t.addEventListener("click",()=>this.showPane(t.dataset.pane));return this}indexPanes(){var t={};for(const e of this.panes)t[e.id]=e;this.panes=t}showPane(t){let e=this.panes[t];return(e=(e=t.startsWith(".")?this.history[1]:e)||this.panes[404]).classList.add("showing"),this.history[0]&&this.history[0].classList.remove("showing"),this.history.unshift(e),this}}class Initializer{constructor(){return this.optEls={declensions:$(".quiz-declension-option",1),vocabNum:$(".quiz-vocab-count")},this.options={declensions:0,vocabNum:0},this}async initialize(t){this.settingsListen();var e=await fetchToJSON("./data/declensions.json"),i=await fetchToJSON("./data/vocab.json");this.fetched={declensions:e,vocab:i}}settingsListen(){for(const t of Object.values(this.optEls.declensions))t.addEventListener("click",t=>{t.target.classList.toggle("selected"),this.options.declensions^=1<<+t.target.dataset.value-1});return this.optEls.vocabNum.addEventListener("input",t=>{this.options.vocabNum=t.target.value}),this}}class Grader{constructor(){}initialize(t,e){}gradeQ(t,e){return!!e&&(e=purify(e))===purify(t.answer)}}class WalkthroughMan{constructor(){this.curQuestionIndex=0,this.container=$(".quiz-content-outer"),this.btns={prev:$(".quiz-prev"),next:$(".quiz-next")},this.userAnswers=[],this.questionTransition=200,this.grader=new Grader}initialize(t){this.questions=t,this.loadQuestion(0,0,1).then(()=>{this.defaultHeight=this.container.getBoundingClientRect().height}),this.updateBtns(),this.btns.next.addEventListener("click",this.toQuestion.bind(this,1,this.questionTransition)),this.btns.prev.addEventListener("click",this.toQuestion.bind(this,-1,this.questionTransition))}toQuestion(t,e){this.curQuestionIndex+=t,this.loadQuestion(this.curQuestionIndex,this.questionTransition,t)}loadQuestion(i,s,t){return this.questions[i]?(this.container.style.height=this.defaultHeight+"px",this.curInput=this.questions[i].html.querySelector("input"),this.btns.curGrade=this.questions[i].html.querySelector(".quiz-grade"),this.btns.curGrade.addEventListener("click",this.showPreliminaryGrade.bind(this)),this.updateBtns(),this.container.classList.add("hidden"),this.container.style.width=this.getHTMLDimensions(this.questions[i].html,"width")+"px",new Promise((t,e)=>{wait(s).then(()=>{this.container.children[0]&&this.container.children[0].remove(),this.container.append(this.questions[i].html),this.inputListen(),this.container.classList.remove("hidden"),t()})})):(this.curQuestionIndex-=t,this.finishQuiz())}getHTMLDimensions(t,e){t.classList.add("invisible"),document.body.append(t);e=t.getBoundingClientRect()[e];return t.classList.remove("invisible"),t.remove(),e}updateBtns(){0===this.curQuestionIndex?this.btns.prev.disabled=!0:this.btns.prev.disabled=!1,this.curInput?.value.replaceAll(" ","")?this.btns.next.disabled=!1:this.btns.next.disabled=!0}inputListen(){this.curInput.onkeyup=t=>{this.updateBtns(),this.userAnswers[this.curQuestionIndex]={response:this.curInput.value,graded:!1}}}showPreliminaryGrade(){var t=this.questions[this.curQuestionIndex],e=(this.curInput.disabled=!0,console.log(this.userAnswers),this.grader.gradeQ(t,this.userAnswers.map(t=>t.response)[this.curQuestionIndex])),e=(this.curInput.classList.add(e?"correct":"wrong"),createElement("div","class:quiz-correct-answer",t.answer)),t=this.getHTMLDimensions(e,"height");this.container.style.height=this.defaultHeight+t+"px",this.container.children[0].append(e)}finishQuiz(){this.grader.finish(this.userAnswers,this.questions)}}class Formulator{constructor(){this.questions=[]}initialize(e,t,i){var s,n={};for(let t=0;t<Math.log2(16)+1;t++){var r=2**t;(r&i.declensions)==r&&(n[t]=e[t+1])}for(s in n)this.questions.push(...this.questionGenerators.declensions.bind(this)(+s+1,n[s]));(new WalkthroughMan).initialize(this.questions)}questionGenerators={vocab(e,i){for(let t=0;t<i;t++){var s=e[Math.floor(Math.random()*e.length)];this.questions.push({type:"vocab",question:s.word,answer:s.translation})}},declensions(t,e,i,s=0,n,r={},a){a??=[],i=i||e;for(var[o,h]of Object.entries(i)){if(0===s&&(r.gender=o),1===s&&(r.gnumber=o),2===s){if("-"===h)break;var u=new Intl.ListFormat("en",{style:"long",type:"disjunction"});(n={question:`${ord(t)} declension ${r.gnumber} ${u.format(r.gender.split("/").map(this.expandGender))} ${o} ending`}).answer=h,n.html=this.htmlGenerator(n),a.push(n)}h===Object(h)&&this.questionGenerators.declensions.bind(this)(t,e,h,s+1,n,r,a)}return a}};htmlGenerator(t){var e=createElement("h3","class:quiz-question-title",t.question),i=createElement("input","placeholder:Enter...;type:text;class:quiz-question-input"),s=createElement("div","class:quiz-grade","Grade"),n=createElement("div","class:quiz-content-inner");return i.correct=t.answer,n.append(e,i,s),n}expandGender=t=>"n"===t?"neuter":"m"===t?"masculine":"f"===t?"feminine":""}var Quiz={Initializer:Initializer,Formulator:Formulator,WalkthroughMan:WalkthroughMan,Grader:Grader};let s=new Switcher,qpb=new Quiz.Initializer,qf=new Quiz.Formulator;qpb.initialize(),$(".pane-trigger.quiz-begin").addEventListener("click",()=>{qf.initialize(qpb.fetched.declensions,qpb.fetched.vocab,qpb.options)}),s.listen().showPane("begin");