const $=(t,e)=>document["querySelector"+(e?"All":"")](t),fetchToJSON=async t=>{return await fetch(t).then(t=>t.json())},ord=t=>t+{e:"st",o:"nd",w:"rd",h:"th"}[new Intl.PluralRules("en",{type:"ordinal"}).select(t)[2]],createElement=(t,e,i)=>{let s=document.createElement(t);return e&&e.split(";").forEach(t=>{t&&(t=t.split(":"),s.setAttribute(t[0].trim(),t[1].trim()))}),s.innerHTML=i||"",s},wait=e=>new Promise(t=>setTimeout(t,e)),purify=t=>t.trim().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace("Ã¦","ae");function shuffleArray(t){for(var e=t.length-1;0<e;e--){var i=Math.floor(Math.random()*(e+1)),s=t[e];t[e]=t[i],t[i]=s}return t}class Switcher{constructor(){return this.panes=$(".pane",1),this.triggers=$(".pane-trigger",1),this.history=[],this}listen(){this.indexPanes();for(const t of this.triggers)t.addEventListener("click",()=>this.showPane(t.dataset.pane));return this}indexPanes(){var t={};for(const e of this.panes)t[e.id]=e;this.panes=t}showPane(t){let e=this.panes[t];return(e=(e=t.startsWith(".")?this.history[1]:e)||this.panes[404]).classList.add("showing"),this.history[0]&&this.history[0].classList.remove("showing"),this.history.unshift(e),this}}let container=createElement("div","class:toast-container");$("#app").append(container);class Grader{constructor(){}initialize(t,e){}gradeQ(t,e){return console.log(t,e),!!e&&(e=purify(e),t.answer.constructor===Array?t.answer.map(purify).includes(e)?{isCorrect:!0,answer:t.answer.join(", ")}:{isCorrect:!1,answer:t.answer}:e!==purify(t.answer)?{isCorrect:!1,answer:t.answer}:{isCorrect:!0,answer:t.answer})}finish(t,e){window.latinstudier.switcher.showPane("quiz-results")}}class WalkthroughMan{constructor(){this.curQuestionIndex=0,this.container=$(".quiz-content-outer"),this.btns={prev:$(".quiz-prev"),next:$(".quiz-next")},this.userAnswers=[],this.questionTransition=200,this.grader=new Grader}initialize(t,e){this.questions=shuffleArray(t),this.options=e,this.loadQuestion(0,0,1).then(()=>this.defaultHeight=this.container.getBoundingClientRect().height),this.updateBtns(),this.btns.next.addEventListener("click",()=>{this.options.immediateGrade&&"Grade"===this.btns.next.innerHTML?(this.gradeQuestion(),this.btns.next.innerHTML="Next"):"Finish"===this.btns.next.innerHTML?this.grader.finish(this.userAnswers,t):"Grade"!==this.btns.next.innerHTML&&this.toQuestion.apply(this,[1,this.questionTransition]),this.curQuestionIndex===this.questions.length-1&&(this.btns.next.innerHTML="Finish")}),this.btns.prev.addEventListener("click",this.toQuestion.bind(this,-1,this.questionTransition)),this.options.immediateGrade&&(this.btns.next.innerHTML="Grade")}toQuestion(t){this.options.immediateGrade&&(this.btns.next.innerHTML="Grade"),this.curQuestionIndex+=t,this.loadQuestion(this.curQuestionIndex,this.questionTransition,t)}loadQuestion(e,i,t){if(!this.questions[e])return this.curQuestionIndex-=t,this.finishQuiz();let s=0;return Math.sign(t)<0&&this.options.immediateGrade&&null!==this.questions[e].graded&&(s=25.5),this.container.style.height=this.defaultHeight+s+"px",this.curInput=this.questions[e].html.querySelector("input"),this.updateBtns(),this.container.classList.add("hidden"),this.container.style.width=this.getHTMLDimensions(this.questions[e].html,"width")+"px",new Promise(t=>{wait(i).then(()=>{this.container.children[0]&&this.container.children[0].remove(),this.container.append(this.questions[e].html),this.inputListen(),this.container.classList.remove("hidden"),t()})})}getHTMLDimensions(t,e){t.classList.add("invisible"),document.body.append(t);e=t.getBoundingClientRect()[e];return t.classList.remove("invisible"),t.remove(),e}updateBtns(){0===this.curQuestionIndex?this.btns.prev.disabled=!0:this.btns.prev.disabled=!1,this.curInput?.value.replaceAll(" ","")||this.questions[this.curQuestionIndex].graded?this.btns.next.disabled=!1:this.btns.next.disabled=!0,this.curQuestionIndex!==this.questions.length-1||this.options.immediateGrade||(this.btns.next.innerHTML="Finish")}inputListen(){this.curInput.onkeyup=t=>{this.updateBtns(),this.userAnswers[this.curQuestionIndex]={response:this.curInput.value,graded:null}}}gradeQuestion(){var t=this.questions[this.curQuestionIndex];if(!t.graded||this.options.immediateGrade){let{isCorrect:i,answer:s}=this.grader.gradeQ(t,this.userAnswers.map(t=>t.response)[this.curQuestionIndex]);console.log(i,s),this.options.immediateGrade&&!function(){this.curInput.disabled=!0,this.curInput.classList.add(i?"correct":"wrong");var t=createElement("div","class:quiz-correct-answer",s),e=this.getHTMLDimensions(t,"height");this.container.style.height=this.defaultHeight+e+"px",this.container.children[0].append(t)}.apply(this),this.questions[this.curQuestionIndex].graded={isCorrect:i,answer:s},this.updateBtns()}}finishQuiz(){this.grader.finish(this.userAnswers,this.questions)}}function declensions(t,e,i=0,s,n={},r){r??=[],n.level||=e;for(var[o,a]of Object.entries(n.level)){if(0===i&&(n.gender=o),1===i&&(n.gnumber=o),2===i){if("-"===a)continue;(s={question:`${ord(t)} declension ${n.gnumber} ${o} ending (${n.gender})`}).answer=a,s.html=generateDeclHTML(s),console.log(s),r.push(s)}a===Object(a)&&(n.level=a,declensions.bind(this)(t,e,i+1,s,n,r))}return r}function generateDeclHTML(t){var t=createElement("h3","class:quiz-question-title",t.question),e=createElement("input","placeholder:What is it? Enter...;type:text;class:quiz-question-input"),i=createElement("div","class:quiz-content-inner");return i.append(t,e),i}function vocab(e,i){var s=[];0===(i=+i)?i=e.length:-1===i&&(i=0),shuffleArray(e);for(let t=0;t<i;t++){var n=e[t];s.push({type:"vocab",question:n.word,answer:n.translation,html:generateVocabHTML(n)})}return s}function generateVocabHTML(t){var t=createElement("h3","class:quiz-question-title",`What does <b>${t.word}</b> mean?`),e=createElement("input","placeholder:What's the translation? Enter...;type:text;class:quiz-question-input"),i=createElement("div","class:quiz-content-inner");return i.append(t,e),i}class Formulator{constructor(t){this.options=t,this.questions=[]}initialize(e,t){var i,s={};console.log(this.options.declensions);for(let t=0;t<Math.log2(16)+1;t++){var n=2**t;(n&this.options.declensions)==n&&(s[t]=e[t+1])}for(i in this.questions.push(...this.questionGenerators.vocab(t,this.options.vocabNum)),s)this.questions.push(...this.questionGenerators.declensions.bind(this)(+i+1,s[i]));(new WalkthroughMan).initialize(this.questions,this.options)}questionGenerators={vocab:vocab,declensions:declensions};expandGender=t=>"n"===t?"neuter":"m"===t?"masculine":"f"===t?"feminine":""}class Initializer{constructor(){return this.optEls={declensions:$(".quiz-declension-option",1),vocabNum:$(".quiz-vocab-count"),immediateGrade:$("#quiz-immediate-grade")},this.options={declensions:0,vocabNum:0,immediateGrade:!0},this}async initialize(){this.settingsListen();var t=await fetchToJSON("./data/declensions.json"),e=await fetchToJSON("./data/vocab.json");Promise.all([t,e]).then(t=>{this.fetched=t})}settingsListen(){for(const t of Object.values(this.optEls.declensions))t.addEventListener("click",t=>{t.target.classList.toggle("selected"),this.options.declensions^=1<<+t.target.dataset.value-1});return this.optEls.vocabNum.addEventListener("input",t=>{this.options.vocabNum=t.target.value}),this.optEls.immediateGrade.addEventListener("input",t=>{this.options.immediateGrade=t.target.checked}),$(".pane-trigger.quiz-begin").addEventListener("click",t=>{if(this.quizIsEmpty())return alert("No declensions and/or vocabulary question number specified."),window.latinstudier.switcher.showPane("quiz-start");new Formulator(this.options).initialize(this.fetched[0],this.fetched[1])}),this}quizIsEmpty=()=>{this.options.declensions||this.options.vocabNum}}var Quiz={Initializer:Initializer,Formulator:Formulator,WalkthroughMan:WalkthroughMan,Grader:Grader};class Studier{constructor(){this.switcher=new Switcher,this.quizInitializer=new Quiz.Initializer}initialize(){this.switcher.listen().showPane("begin"),this.quizInitializer.initialize()}}window.latinstudier=new Studier,latinstudier.initialize();