const $=(t,e)=>document["querySelector"+(e?"All":"")](t),fetchToJSON=async t=>{return await fetch(t).then(t=>t.json())},ord=t=>t+{e:"st",o:"nd",w:"rd",h:"th"}[new Intl.PluralRules("en",{type:"ordinal"}).select(t)[2]],createElement=(t,e,s)=>{let i=document.createElement(t);return e&&e.split(";").forEach(t=>{t&&(t=t.split(":"),i.setAttribute(t[0].trim(),t[1].trim()))}),i.innerHTML=s||"",i},wait=e=>new Promise(t=>setTimeout(t,e)),purify=t=>t.trim().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace("Ã¦","ae");class Switcher{constructor(){return this.panes=$(".pane",1),this.triggers=$(".pane-trigger",1),this.history=[],this}listen(){this.indexPanes();for(const t of this.triggers)t.addEventListener("click",()=>this.showPane(t.dataset.pane));return this}indexPanes(){var t={};for(const e of this.panes)t[e.id]=e;this.panes=t}showPane(t){let e=this.panes[t];return(e=(e=t.startsWith(".")?this.history[1]:e)||this.panes[404]).classList.add("showing"),this.history[0]&&this.history[0].classList.remove("showing"),this.history.unshift(e),this}}let typeMap=["info","success","error"],queue=[],id=0,container=createElement("div","class:toast-container");$("#app").append(container);class Message{constructor(t,e,s,i){e=createElement("div","class:toast "+typeMap[e]);i&&e.append(createElement("h3","class:toast-header",i)),e.append(createElement("p","class:toast-description "+(i?"smaller":""),t)),this.el=e,this.duration=s,this.id=(id++).toString(16),queue.push(this),wantToShow(this.id)}}function wantToShow(){queue.length&&showMessage(queue[0]).then(()=>{queue.shift(),console.log(queue),wantToShow()})}function showMessage({el:e,duration:s}){return new Promise(async t=>{container.append(e),await wait(s),e.classList.add("hidden"),wait(200).then(()=>{e.remove(),t()})})}class Grader{constructor(){}initialize(t,e){}gradeQ(t,e){return!!e&&(e=purify(e))===purify(t.answer)}}class WalkthroughMan{constructor(){this.curQuestionIndex=0,this.container=$(".quiz-content-outer"),this.btns={prev:$(".quiz-prev"),next:$(".quiz-next")},this.userAnswers=[],this.questionTransition=200,this.grader=new Grader}initialize(t){this.questions=t,this.loadQuestion(0,0,1).then(()=>{this.defaultHeight=this.container.getBoundingClientRect().height}),this.updateBtns(),this.btns.next.addEventListener("click",this.toQuestion.bind(this,1,this.questionTransition)),this.btns.prev.addEventListener("click",this.toQuestion.bind(this,-1,this.questionTransition))}toQuestion(t,e){this.curQuestionIndex+=t,this.loadQuestion(this.curQuestionIndex,this.questionTransition,t)}loadQuestion(e,s,t){return this.questions[e]?(this.container.style.height=this.defaultHeight+"px",this.curInput=this.questions[e].html.querySelector("input"),this.btns.curGrade=this.questions[e].html.querySelector(".quiz-grade"),this.btns.curGrade.addEventListener("click",this.showPreliminaryGrade.bind(this)),this.updateBtns(),this.container.classList.add("hidden"),this.container.style.width=this.getHTMLDimensions(this.questions[e].html,"width")+"px",new Promise(t=>{wait(s).then(()=>{this.container.children[0]&&this.container.children[0].remove(),this.container.append(this.questions[e].html),this.inputListen(),this.container.classList.remove("hidden"),t()})})):(this.curQuestionIndex-=t,this.finishQuiz())}getHTMLDimensions(t,e){t.classList.add("invisible"),document.body.append(t);e=t.getBoundingClientRect()[e];return t.classList.remove("invisible"),t.remove(),e}updateBtns(){0===this.curQuestionIndex?this.btns.prev.disabled=!0:this.btns.prev.disabled=!1,this.curInput?.value.replaceAll(" ","")?this.btns.next.disabled=!1:this.btns.next.disabled=!0}inputListen(){this.curInput.onkeyup=t=>{this.updateBtns(),this.userAnswers[this.curQuestionIndex]={response:this.curInput.value,graded:!1}}}showPreliminaryGrade(){var t,e=this.questions[this.curQuestionIndex];e.graded||(this.curInput.disabled=!0,t=this.grader.gradeQ(e,this.userAnswers.map(t=>t.response)[this.curQuestionIndex]),this.curInput.classList.add(t?"correct":"wrong"),t=createElement("div","class:quiz-correct-answer",e.answer),e=this.getHTMLDimensions(t,"height"),this.container.style.height=this.defaultHeight+e+"px",this.container.children[0].append(t),this.questions[this.curQuestionIndex].graded=!0)}finishQuiz(){this.grader.finish(this.userAnswers,this.questions)}}class Formulator{constructor(){this.questions=[]}initialize(e,t,s){var i,n={};for(let t=0;t<Math.log2(16)+1;t++){var r=2**t;(r&s.declensions)==r&&(n[t]=e[t+1])}for(i in n)this.questions.push(...this.questionGenerators.declensions.bind(this)(+i+1,n[i]));(new WalkthroughMan).initialize(this.questions)}questionGenerators={vocab(e,s){for(let t=0;t<s;t++){var i=e[Math.floor(Math.random()*e.length)];this.questions.push({type:"vocab",question:i.word,answer:i.translation})}},declensions(t,e,s=0,i,n={},r){r??=[],n.level||=e;for(var[a,o]of Object.entries(n.level)){if(0===s&&(n.gender=a),1===s&&(n.gnumber=a),2===s){if("-"===o)break;var h=new Intl.ListFormat("en",{style:"long",type:"disjunction"});(i={question:`${ord(t)} declension ${n.gnumber} ${h.format(n.gender.split("/").map(this.expandGender))} ${a} ending`}).answer=o,i.html=this.htmlGenerator(i),r.push(i)}o===Object(o)&&(n.level=o,this.questionGenerators.declensions.bind(this)(t,e,s+1,i,n,r))}return r}};htmlGenerator(t){var e=createElement("h3","class:quiz-question-title",t.question),s=createElement("input","placeholder:Enter...;type:text;class:quiz-question-input"),i=createElement("div","class:quiz-grade","Grade"),n=createElement("div","class:quiz-content-inner");return s.correct=t.answer,n.append(e,s,i),n}expandGender=t=>"n"===t?"neuter":"m"===t?"masculine":"f"===t?"feminine":""}class Initializer{constructor(){return this.optEls={declensions:$(".quiz-declension-option",1),vocabNum:$(".quiz-vocab-count")},this.options={declensions:0,vocabNum:0},this}async initialize(t){this.settingsListen();var e=await fetchToJSON("./data/declensions.json"),s=await fetchToJSON("./data/vocab.json");this.fetched={declensions:e,vocab:s}}settingsListen(){for(const t of Object.values(this.optEls.declensions))t.addEventListener("click",t=>{t.target.classList.toggle("selected"),this.options.declensions^=1<<+t.target.dataset.value-1});return this.optEls.vocabNum.addEventListener("input",t=>{this.options.vocabNum=t.target.value}),$(".pane-trigger.quiz-begin").addEventListener("click",()=>{(new Formulator).initialize(this.fetched.declensions,this.fetched.vocab,this.options)}),this}quizIsEmpty=()=>!declensions&&!vocabNum}var Quiz={Initializer:Initializer,Formulator:Formulator,WalkthroughMan:WalkthroughMan,Grader:Grader};let s=new Switcher;s.listen().showPane("begin"),new Message,(new Quiz.Initializer).initialize();