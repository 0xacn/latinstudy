const $=(e,t)=>document["querySelector"+(t?"All":"")](e),fetchToJSON=async e=>{return await fetch(e).then(e=>e.json())},ord=e=>e+{e:"st",o:"nd",w:"rd",h:"th"}[new Intl.PluralRules("en",{type:"ordinal"}).select(e)[2]],createElement=(e,t,i)=>{let s=document.createElement(e);return t&&t.split(";").forEach(e=>{e&&(e=e.split(":"),s.setAttribute(e[0].trim(),e[1].trim()))}),s.innerHTML=i||"",s},wait=t=>new Promise(e=>setTimeout(e,t)),purify=e=>e.trim().normalize("NFKD").replace(/[\u0300-\u036f]/g,"").replace("Ã¦","ae").toLowerCase();function shuffleArray(e){for(var t=e.length-1;0<t;t--){var i=Math.floor(Math.random()*(t+1)),s=e[t];e[t]=e[i],e[i]=s}return e}function renderAnswer(i){let r=createElement("span","class:rendered-answer");const s=(e,t,i)=>{var s=t.split("|"),n=s[0],s=s[1];r.append(n),s&&r.append(createElement("span","class:answer-note",`(${s})`)),i!==(e??t).length-1&&r.append(", ")};return i.constructor===Array?i.forEach((e,t)=>s(i,e,t)):s("",i,-1),r}class Switcher{constructor(){return this.panes=$(".pane",1),this.triggers=$(".pane-trigger",1),this.history=[],this}listen(){this.indexPanes();for(const e of this.triggers)e.addEventListener("click",()=>this.showPane(e.dataset.pane));return this}indexPanes(){var e={};for(const t of this.panes)e[t.id]=t;this.panes=e}showPane(e){let t=this.panes[e];return(t=(t=e.startsWith(".")?this.history[1]:t)||this.panes[404]).classList.add("showing"),this.history[0]&&this.history[0].classList.remove("showing"),this.history.unshift(t),this}}let container=createElement("div","class:toast-container");$("#app").append(container);class Grader{constructor(){}initialize(e,t){}gradeQ(e,t){return console.log(e,t),!!t&&(t=purify(t),e.answer.constructor===Array?e.answer.map(purify).includes(t)?{isCorrect:!0,answer:e.answer.join(", ")}:{isCorrect:!1,answer:e.answer}:t!==purify(e.answer)?{isCorrect:!1,answer:e.answer}:{isCorrect:!0,answer:e.answer})}finish(e){window.latinstudier.switcher.showPane("quiz-results");let t=0;for(var[i,s]of e.entries()){var i=createElement("div","class:quiz-results-q",`${i+1}. ${s.question}: `),n=createElement("span","class:quiz-results-q-wrong",s.graded.userAnswer),r=createElement("span","class:quiz-results-q-correct");r.append(renderAnswer(s.answer)),!0===s.graded.isCorrect?t++:i.append(n),i.append(r),$("#quiz-results-questions-inner").append(i)}$("#quiz-results-percentage").textContent=Math.round(t/e.length*1e3)/10,$("#quiz-results-num-correct").textContent=t,$("#quiz-results-total").textContent=e.length}}class WalkthroughMan{constructor(){this.curQuestionIndex=0,this.container=$(".quiz-content-outer"),this.btns={prev:$(".quiz-prev"),next:$(".quiz-next")},this.userAnswers=[],this.questionTransition=200,this.grader=new Grader}initialize(e,t){this.questions=shuffleArray(e),this.options=t,this.timeTo=this.options.immediateGrade?1:2,this.loadQuestion(0,0,1).then(()=>this.defaultHeight=this.container.getBoundingClientRect().height),this.updateDisable(),this.btns.next.addEventListener("click",()=>{if(console.log(this.timeTo),1===this.timeTo)this.gradeQuestion(),this.timeTo=this.curQuestionIndex===this.questions.length-1?3:2;else if(2===this.timeTo)this.toQuestion.apply(this,[1,this.questionTransition]),this.options.immediateGrade&&(this.timeTo=1);else if(3===this.timeTo)return this.grader.finish(e);this.updateNextBtn()}),this.btns.prev.addEventListener("click",this.toQuestion.bind(this,-1,this.questionTransition)),this.options.immediateGrade&&(this.btns.next.innerHTML="Grade")}toQuestion(e){this.options.immediateGrade&&(this.btns.next.innerHTML="Grade"),this.curQuestionIndex+=e,this.loadQuestion(this.curQuestionIndex,this.questionTransition,e)}loadQuestion(t,i,e){if(!this.questions[t])return this.curQuestionIndex-=e,this.finishQuiz();let s=0;return Math.sign(e)<0&&this.options.immediateGrade&&null!==this.questions[t].graded&&(s=25.5),this.container.style.height=this.defaultHeight+s+"px",this.curInput=this.questions[t].html.querySelector("input"),this.updateDisable(),this.container.classList.add("hidden"),this.container.style.width=this.getHTMLDimensions(this.questions[t].html,"width")+"px",new Promise(e=>{wait(i).then(()=>{this.container.children[0]&&this.container.children[0].remove(),this.container.append(this.questions[t].html),this.inputListen(),this.container.classList.remove("hidden"),e()})})}getHTMLDimensions(e,t){e.classList.add("invisible"),document.body.append(e);t=e.getBoundingClientRect()[t];return e.classList.remove("invisible"),e.remove(),t}updateDisable(){0===this.curQuestionIndex?this.btns.prev.disabled=!0:this.btns.prev.disabled=!1,this.curInput?.value.replaceAll(" ","")||this.questions[this.curQuestionIndex].graded?this.btns.next.disabled=!1:this.btns.next.disabled=!0}updateNextBtn(){1===this.timeTo?this.btns.next.innerHTML="Grade":2===this.timeTo?this.btns.next.innerHTML="Next":3===this.timeTo&&(this.btns.next.innerHTML="Finish")}inputListen(){this.curInput.onkeyup=e=>{if("Enter"===e.key)return this.btns.next.click();this.updateDisable(),this.userAnswers[this.curQuestionIndex]={response:this.curInput.value,graded:null}}}gradeQuestion(){var e=this.questions[this.curQuestionIndex];if(!e.graded||this.options.immediateGrade){var t=this.userAnswers.map(e=>e.response)[this.curQuestionIndex];let{isCorrect:i,answer:s}=this.grader.gradeQ(e,this.userAnswers.map(e=>e.response)[this.curQuestionIndex]);this.options.immediateGrade&&!function(){this.curInput.disabled=!0,this.curInput.classList.add(i?"correct":"wrong");var e=createElement("div","class:quiz-correct-answer"),t=(e.append(renderAnswer(s)),this.getHTMLDimensions(e,"height"));this.container.style.height=this.defaultHeight+t+"px",this.container.children[0].append(e)}.apply(this),this.questions[this.curQuestionIndex].graded={isCorrect:i,answer:s,userAnswer:t},this.updateDisable()}}finishQuiz(){this.grader.finish(this.questions),this.questions=[],this.timeTo=1,this.userAnswers=[]}}function declensions(e,t,i=0,s,n={},r){r??=[],n.level||=t;for(var[a,o]of Object.entries(n.level)){if(0===i&&(n.gender=a),1===i&&(n.gnumber=a),2===i){if("-"===o)continue;(s={question:`${ord(e)} declension ${n.gnumber} ${a} ending (${n.gender})`}).answer=o,s.html=generateDeclHTML(s),console.log(s),r.push(s)}o===Object(o)&&(n.level=o,declensions.bind(this)(e,t,i+1,s,n,r))}return r}function generateDeclHTML(e){var e=createElement("h3","class:quiz-question-title",e.question),t=createElement("input","placeholder:What is it? Enter...;type:text;class:quiz-question-input"),i=createElement("div","class:quiz-content-inner");return i.append(e,t),i}function vocab(t,i){var s=[];0===(i=+i)?i=t.length:-1===i&&(i=0),shuffleArray(t);for(let e=0;e<i;e++){var n=t[e];s.push({type:"vocab",question:n.word,answer:n.translation,html:generateVocabHTML(n)})}return s}function generateVocabHTML(e){var e=createElement("h3","class:quiz-question-title",`What does <b>${e.word}</b> mean?`),t=createElement("input","placeholder:What's the translation? Enter...;type:text;class:quiz-question-input"),i=createElement("div","class:quiz-content-inner");return i.append(e,t),i}class Formulator{constructor(e){this.options=e,this.questions=[]}initialize(t,e){var i,s={};console.log(this.options.declensions);for(let e=0;e<Math.log2(16)+1;e++){var n=2**e;(n&this.options.declensions)==n&&(s[e]=t[e+1])}for(i in this.questions.push(...this.questionGenerators.vocab(e,this.options.vocabNum)),s)this.questions.push(...this.questionGenerators.declensions.bind(this)(+i+1,s[i]));(new WalkthroughMan).initialize(this.questions,this.options)}questionGenerators={vocab:vocab,declensions:declensions};expandGender=e=>"n"===e?"neuter":"m"===e?"masculine":"f"===e?"feminine":""}class Initializer{constructor(){return this.optEls={declensions:$(".quiz-declension-option",1),vocabNum:$(".quiz-vocab-count"),immediateGrade:$("#quiz-immediate-grade")},this.options={declensions:0,vocabNum:0,immediateGrade:!0},this}async initialize(){this.settingsListen();var e=await fetchToJSON("./data/declensions.json"),t=await fetchToJSON("./data/vocab.json");Promise.all([e,t]).then(e=>{this.fetched=e})}settingsListen(){for(const e of Object.values(this.optEls.declensions))e.addEventListener("click",e=>{e.target.classList.toggle("selected"),this.options.declensions^=1<<+e.target.dataset.value-1});return this.optEls.vocabNum.addEventListener("input",e=>{this.options.vocabNum=e.target.value}),this.optEls.immediateGrade.addEventListener("input",e=>{this.options.immediateGrade=e.target.checked}),$(".pane-trigger.quiz-begin").addEventListener("click",e=>{if(this.quizIsEmpty())return alert("No declensions and/or vocabulary question number specified."),window.latinstudier.switcher.showPane("quiz-start");new Formulator(this.options).initialize(this.fetched[0],this.fetched[1])}),this}quizIsEmpty=()=>{this.options.declensions||this.options.vocabNum}}var Quiz={Initializer:Initializer,Formulator:Formulator,WalkthroughMan:WalkthroughMan,Grader:Grader};class Studier{constructor(){this.switcher=new Switcher,this.quizInitializer=new Quiz.Initializer}initialize(){this.switcher.listen().showPane("begin"),this.quizInitializer.initialize()}}window.latinstudier=new Studier,latinstudier.initialize();